name: CD
on:
  - push
  - pull_request

jobs:
  build-win:
    name: win build (msys2)
    if: github.event_name == 'push'
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v2
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: git cmake make mingw-w64-x86_64-toolchain mingw-w64-x86_64-qt6-base mingw-w64-x86_64-qt6-svg mingw-w64-x86_64-qt6-tools mingw-w64-x86_64-nsis zip unzip
      - name: Configure
        run: |
          mkdir build
          cd build
          cmake ..
      - name: Build
        run: cmake --build build
      - name: Package
        id: package
        run: |
          cd build
          ./.github/scripts/package_msys.sh
          echo "::set-output name=VERSION_NAME::${VERSION_NAME}"

      - name: Upload zip to GitHub Artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v2
        with:
          name: qdia-win-qt6-zip
          path: |
            cd build
            ./package-zip/qdia-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.zip
          
      - name: Upload to GitHub Artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v2
        with:
          name: qdia-win-qt6-exe
          path: qdia-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.exe
        
      - name: Release exe
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            qdia-${{ steps.package.outputs.GIT_VERSION }}-win-qt6.exe
            qdia-${{ steps.package.outputs.GIT_VERSION }}-win-portable-qt6.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}

   
############################
      
  macosx:
    name: Mac OS X
    runs-on: macos-10.15

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Fetch tag annotations
      run: git fetch --tags --force

    - name: Install Dependencies
      run: |
        brew install qt6

    - name: Configure
      run: |
        mkdir build
        cd build
        cmake ..

    - name: Build
      run: cmake --build build

    - name: Package
      id: package
      run: |
        cd build
        /usr/local/opt/qt6/bin/macdeployqt qdia.app -dmg
        VESION_NAME=0.1
        cp qdia.dmg qdia-osx-${GIT_VERSION}.dmg
        echo "::set-output name=VERSION_NAME::${VERSION_NAME}"
        echo "::set-output name=TXS_VERSION::${TXS_VERSION}"
        echo "::set-output name=GIT_VERSION::${GIT_VERSION}"
        
    - name: Upload to Github artifacts
      if: github.event_name == 'push'
      uses: actions/upload-artifact@v2
      with:
        name: qdia-osx
        path: qdia-osx-${{ steps.package.outputs.VERSION_NAME }}.dmg
        
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        files: qdia-${{ steps.package.outputs.GIT_VERSION }}-osx.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}
        
 
